const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = 320;
canvas.height = 200;

// ===== GAME STATE =====
let started = false;
let gameOver = false;

// ===== MAP =====
const TILE = 16;
const MAP = [
  "####################",
  "#......#...........#",
  "#.####.#.#####.###..#",
  "#.#....#.....#.#...#",
  "#.#.#########.#.#.##",
  "#.#...........#.#..#",
  "#.###########.#.##.#",
  "#.............#....#",
  "###########E########"
];

function isWall(px, py) {
  const x = Math.floor(px / TILE);
  const y = Math.floor(py / TILE);
  if (!MAP[y] || !MAP[y][x]) return true;
  return MAP[y][x] === "#";
}

// ===== PLAYER =====
const player = {
  x: 32,
  y: 32,
  speed: 1,
  fear: 0
};

// ===== MONSTER =====
const monster = {
  x: 240,
  y: 144,
  speed: 0.4,
  active: false
};

// ===== INPUT =====
const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

// ===== AUDIO (GENERATED) =====
let audioCtx, humOsc, humGain;

function startAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  humOsc = audioCtx.createOscillator();
  humOsc.type = "sine";
  humOsc.frequency.value = 35;

  humGain = audioCtx.createGain();
  humGain.gain.value = 0.03;

  humOsc.connect(humGain);
  humGain.connect(audioCtx.destination);
  humOsc.start();
}

// ===== START =====
document.getElementById("overlay").onclick = () => {
  if (!started) {
    startAudio();
    started = true;
    document.getElementById("overlay").remove();
  }
};

// ===== HELPERS =====
function dist(a, b) {
  return Math.hypot(a.x - b.x, a.y - b.y);
}

// ===== UPDATE =====
function update() {
  if (!started || gameOver) return;

  let nx = player.x;
  let ny = player.y;
  let moving = false;

  if (keys["w"] || keys["ArrowUp"]) { ny -= player.speed; moving = true; }
  if (keys["s"] || keys["ArrowDown"]) { ny += player.speed; moving = true; }
  if (keys["a"] || keys["ArrowLeft"]) { nx -= player.speed; moving = true; }
  if (keys["d"] || keys["ArrowRight"]) { nx += player.speed; moving = true; }

  if (!isWall(nx, player.y)) player.x = nx;
  if (!isWall(player.x, ny)) player.y = ny;

  // Fear system
  const d = dist(player, monster);
  if (d < 120) {
    player.fear = Math.min(1, player.fear + 0.002);
    monster.active = true;
  } else {
    player.fear = Math.max(0, player.fear - 0.001);
  }

  // Audio reacts to fear
  humGain.gain.value = 0.03 + player.fear * 0.12;
  humOsc.frequency.value = 35 + player.fear * 50;

  // Monster moves only if player moves
  if (monster.active && moving) {
    const ang = Math.atan2(player.y - monster.y, player.x - monster.x);
    monster.x += Math.cos(ang) * monster.speed;
    monster.y += Math.sin(ang) * monster.speed;
  }

  // Death
  if (d < 8) {
    gameOver = true;
    setTimeout(() => {
      alert("You were never alone.");
      location.reload();
    }, 100);
  }

  // Escape
  const tile = MAP[Math.floor(player.y / TILE)][Math.floor(player.x / TILE)];
  if (tile === "E") {
    gameOver = true;
    setTimeout(() => {
      alert("You escaped.\nSomething followed.");
      location.reload();
    }, 100);
  }
}

// ===== DRAW =====
function draw() {
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Map
  for (let y = 0; y < MAP.length; y++) {
    for (let x = 0; x < MAP[y].length; x++) {
      if (MAP[y][x] === "#") {
        ctx.fillStyle = "#222";
        ctx.fillRect(x * TILE, y * TILE, TILE, TILE);
      }
      if (MAP[y][x] === "E") {
        ctx.fillStyle = "white";
        ctx.fillRect(x * TILE + 4, y * TILE + 4, 8, 8);
      }
    }
  }

  // Darkness
  ctx.fillStyle = "rgba(0,0,0,0.85)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Light radius
  ctx.save();
  ctx.globalCompositeOperation = "destination-out";
  ctx.beginPath();
  ctx.arc(player.x, player.y, 50 - player.fear * 25, 0, Math.PI * 2);
  ctx.fill();
  ctx.restore();

  // Monster (barely visible)
  if (monster.active) {
    ctx.fillStyle = "rgba(255,255,255,0.15)";
    ctx.fillRect(monster.x - 4, monster.y - 4, 8, 8);
  }

  // Player
  ctx.fillStyle = "white";
  ctx.fillRect(player.x - 2, player.y - 2, 4, 4);

  // Title
  ctx.fillStyle = "rgba(255,255,255,0.5)";
  ctx.fillText("Echoes Of Solitude", 6, 12);
}

// ===== LOOP =====
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
